<html py:extends="master.xhtml" py:strip="True">
<head py:block="head" py:strip="True">
    <title py:block="master_title">Precondizione</title>
    <script id="PreconditionSimpleForm_template" type="text/html">
        <![CDATA[
        <form id="precondition-simple-form" class="form-horizontal" on-submit="submit-form">
            <div class="form-group" style="padding-top: 20px">
                <div class="col-md-6 text-left ks-section-name">
                    Precondizione Semplice
                </div>
                <div class="col-md-6 text-right">
                    {{#if saving}}
                    Saving...
                    {{else}}
                    <button type="submit" class="btn btn-primary">${h.material_icon('save')} Salva</button>
                    {{/if}}
                </div>
            </div>
            <hr/>

             <div class="form-group {{errors.question ? 'has-error' : ''}}">
                <div class="col-sm-3">
                    <select id="selected_question" class="form-control" value="{{create.question}}">
                        <option value="" disabled selected>Seleziona una domanda</option>
                        {{#each questions}}
                        <option value="{{._id}}">{{.title}}</option>
                        {{/each}}
                    </select>

                    {{#if errors.question}}
                    <span class="help-block">{{errors.question}}</span>
                    {{/if}}
                </div>
            </div>

            <div class="form-group {{errors.answer_type ? 'has-error' : ''}}">
                <div class="col-md-12">
                    <div class="radio">
                      <label>
                        <input type="radio" name="{{create.answer_type}}" value="have_response" />
                        Utente ha risposto alla domanda
                      </label>
                    </div>
                    <div class="radio">
                      <label>
                        <input type="radio" name="{{create.answer_type}}" value="what_response" />
                        L'utente ha selezionato uno dei seguenti valori
                      </label>
                    </div>
                </div>
                {{#if errors.answer_type}}
                <span class="help-block">{{errors.answer_type}}</span>
                {{/if}}
            </div>

            <div class="form-group {{errors.interested_response ? 'has-error' : ''}}">
                {{#each available_reponse}}
                <div class="col-md-12">
                    <input type="checkbox" name="{{create.interested_response}}" value="{{.}}" > {{.}}
                </div>
                {{/each}}

                {{#if errors.interested_response}}
                <span class="help-block">{{errors.interested_response}}</span>
                {{/if}}
            </div>


            <div class="form-group {{errors.title ? 'has-error' : ''}}">
                <div class="col-sm-3">
                    <input id="extra-fields-form-title" type="text" class="form-control" placeholder="TITOLO" value="{{create.title}}"/>
                    {{#if errors.title}}
                    <span class="help-block">{{errors.title}}</span>
                    {{/if}}
                </div>
            </div>
        </form>
    ]]>
    </script>
</head>

<body py:block="body" py:strip="True">
<div id="qa-ractive" style="padding-top: 20px">

</div>
<script>
    <![CDATA[
    var PreconditionSimple = Ractive.extend({
        template: '#PreconditionSimpleForm_template',
        onconstruct: function(options) {
            var self = this;
        },
        oninit: function() {
            var self = this;
            self.set('errors', {});
            self.set('saving', false);
            self.set('response_type', null);
            self.set('available_reponse', []);

            self.on('submit-form', function(event) {
                var all_var = self.get('create');
                console.log("Sto inviando");
                console.log(all_var);
                self.createPreconditionSimple(all_var);
                return false;
            });

            self.loadQuestion();
        },
        loadQuestion: function(callback) {
            var self = this;
            jQuery.get("${tg.url('/qa/get_single_or_multi_question')}",
                    function(data) {
                        self.set('questions', data['questions']);
                        if (callback)
                            callback();
                    });
        },
        createPreconditionSimple: function(field) {
            var self = this;
            //self.set('saving', true);
            console.log("JSON.stringify");
            console.log(field);
            console.log(JSON.stringify(field));

            var api_params = JSON.stringify(field);

            $.ajax({
                type: "post",
                url: "${tg.url('/precondition/simple/post')}",
                data: api_params,
                dataType: "json",
                processData: false,
                contentType: 'application/json'
            }).done(function(data) {
                self.set('create', {});
                self.set('saving', false);
                self.set('editing', false);
                console.log(data);


            }).fail(function(jqXHR) {
                var data = jQuery.parseJSON(jqXHR.responseText);
                console.log("fail");
                console.log(data);
                self.set('errors', data.errors);
                self.set('saving', false);
            });

        }
    });
    ]]>
</script>
<script>
    var ractive_precondition_simple = new PreconditionSimple({el: '#qa-ractive'});

    ractive_precondition_simple.observe('create.question', function ( resp_id, oldValue ) {
      var self = this;
      if (!resp_id) return;

      self.set('create.title', '');
      self.set('available_reponse', []);
      console.log(resp_id);
      jQuery.get("${tg.url('/qa/get_one')}", {'id':resp_id}, function(data) {
          self.set('available_reponse', data['qa']['answers'])
      })
    });

</script>
</body>
</html>
