<html py:extends="master.xhtml" py:strip="True">
<head py:block="head" py:strip="True">
  <title py:block="master_title">KS | Output</title>

  <script id="OutputForm_template" type="text/html">
    <![CDATA[
    <form class="form-horizontal" on-submit="submit-form">
      <div class="form-group" style="padding-top: 20px">
        <div class="col-md-6 text-left ks-section-name">
          Output
        </div>
        <div class="col-md-6 text-right">
          {{#if saving}}
          Salvataggio...
          {{else}}
          <button type="submit" class="btn btn-primary">${h.material_icon('save')} Salva</button>
          {{/if}}
        </div>
      </div>
      <hr/>
      <div class="form-group {{errors.title ? 'has-error' : ''}}">
        <div class="col-sm-3">
          <input id="form-title" type="text" class="form-control" placeholder="Titolo" value="{{create.title}}"/>
          {{#if errors.title}}
          <span class="help-block">{{errors.title}}</span>
          {{/if}}
        </div>
      </div>
      <div class="form-group {{errors.category ? 'has-error' : ''}}">
        <div class="col-sm-3">
          <select id="form-category" class="form-control" value="{{create.category}}">
            <option value="" disabled selected>Seleziona una categoria</option>
            {{#each categories}}
            <option value="{{._id}}">{{.name}}</option>
            {{/each}}
          </select>

          {{#if errors.category}}
          <span class="help-block">{{errors.category}}</span>
          {{/if}}
        </div>
      </div>
      <div class="form-group {{errors.precondition ? 'has-error' : ''}}">
        <div class="col-sm-3">
          <select id="form-precondition" class="form-control" value="{{create.precondition}}">
            <option value="" disabled selected>Seleziona una precondizione</option>
            {{#each preconditions}}
            <option value="{{._id}}">{{.title}}</option>
            {{/each}}
          </select>

          {{#if errors.precondition}}
          <span class="help-block">{{errors.precondition}}</span>
          {{/if}}
        </div>
      </div>
      <div class="form-group">
        Azioni:
        <span onclick="ractive_output.addText()">${h.material_icon('create')}</span>
      </div>
      <div class="form-group {{errors.content ? 'has-error' : ''}}">
        {{#create.content:i}}
          <span class="editor-element">
              {{#if .type == 'text'}}
                <span class="editor-text" contenteditable="true" value="{{.content}}" on-click="selectElem:{{.}}"></span>
              {{/if}}

              {{#if .type == 'precond'}}
                <span on-click="selectElem:{{.}}">{{.title}}</span>
              {{/if}}
              <span id="delete_elem" class="cursor-pointer" on-click="deleteElem:{{i}}">${h.material_icon('add_circle_outline_rotate')}</span>
          </span>
        {{/items}}

        {{#if errors.content}}
        <span class="help-block">{{errors.content}}</span>
        {{/if}}
      </div>
      <!--
      <div class="form-group {{errors.content ? 'has-error' : ''}}">
        <div class="col-sm-3">
          <textarea class="form-control" rows="5" id="form-content" value="{{create.content}}" placeholder="Inserisci output"></textarea>
          {{#if errors.content}}
          <span class="help-block">{{errors.content}}</span>
          {{/if}}
        </div>
      </div>
      -->
    </form>
    ]]>
  </script>
</head>

<body py:block="body" py:strip="True">
<div id="output-ractive" style="padding-top: 20px">

</div>
<script>
  var OutputEditor = Ractive.extend({
    template: '#OutputForm_template',
    onconstruct: function(options) {
      var self = this;
      //  Default settings
      self.submit_type = 'POST';
      self.submit_url = '${tg.url('/output/post')}';
      self.edit_mode=false;
      self.output = options['output'];

    },
    oninit: function() {
      var self = this;

      self.set('create.content', []);

      //  Check if document is provided
      if (! jQuery.isEmptyObject(self.output)) {
        self.edit_mode = true;
        self.submit_type = 'PUT';
        self.submit_url = '${tg.url('/output/put')}';

        //Set the output value as default
        self.set('create.title', self.output['title']);
        self.set('create.category', self.output['_category']);
        self.set('create.precondition', self.output['_precondition']);
        self.set('create._id', self.output['_id']);
        self.set('create.content', self.output['content']);
      }

      self.set('errors', {});
      self.set('saving', false);

      self.on('submit-form', function(event) {
        console.log(self.get('create'));
        self.create_output(self.get('create'));
        return false;
      });

      self.loadCategories();
      self.loadPrecondition();
    },
    loadCategories: function(callback) {
      var self = this;
      jQuery.get("${tg.url('/category/get_all')}",
          function(data) {
            self.set('categories', data['categories']);
            if (callback)
              callback();
          });
    },
    loadPrecondition: function(callback) {
      var self = this;
      jQuery.get("${tg.url('/precondition/available_preconditions')}",
          function(data) {
            self.set('preconditions', data['preconditions']);
            if (callback)
              callback();
          });
    },
    addText: function() {
      var self = this;
      var elem = {
        'type':"text",
        'content': "Testo",
        'title': ""
      };
      self.get('create.content').push(elem);
    },
    create_output: function(field) {
      var self = this;
      self.set('saving', true);
      console.log("JSON.stringify");
      console.log(JSON.stringify(field));

      var api_params = JSON.stringify(field);

      $.ajax({
        type: self.submit_type,
        url: self.submit_url,
        data: api_params,
        dataType: "json",
        processData: false,
        contentType: 'application/json'
      }).done(function(data) {
        self.set('create', {});
        self.set('saving', false);
        self.set('editing', false);
        window.location.replace("${tg.url('/output/')}");
      }).fail(function(jqXHR) {
        var data = jQuery.parseJSON(jqXHR.responseText);
        console.log("fail");
        console.log(data);
        self.set('errors', data.errors);
        self.set('saving', false);
      });
    }
  });
</script>
<script>
  var ractive_output = new OutputEditor({
    el: '#output-ractive',
    output: ${Markup(h.script_json_encode(output))},
  });

  ractive_output.on('selectElem', function ( event, elem ) {
    var self = this;
    console.log("Selected element: "+ elem.content);
  });

  ractive_output.on('deleteElem', function ( event, elem ) {
    var self = this;
    console.log("Element to remove: "+ elem);
    self.splice('create.content', elem, 1)
  });
</script>
</body>
</html>
