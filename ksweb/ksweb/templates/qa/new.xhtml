<html py:extends="master.xhtml" py:strip="True">
<head py:block="head" py:strip="True">
    <title py:block="master_title">KS | Nuova QA</title>
    <style>

        label > input{ /*HIDE RADIO*/
            display:none;
        }
        label > input + img{  /*IMAGE STYLES*/
            cursor:pointer;
            border:2px solid transparent;
        }
        label > input:checked + img{  /*(CHECKED) IMAGE STYLES*/
            border:2px solid blue;
        }

        input[type="radio"], input[type="checkbox"] {
            vertical-align: middle;
            height: 24px;
            width: 24px;
            margin: 2px 2px 0;
            line-height: normal;
        }

    </style>
    <script id="QAForm_template" type="text/html">
        <![CDATA[
        <form class="form-horizontal" on-submit="submit-form">
            <div class="form-group" style="padding-top: 20px">
                <div class="col-md-6 text-left ks-section-name">
                    Crea Q / A
                </div>
                <div class="col-md-6 text-right">
                    {{#if saving}}
                    Saving...
                    {{else}}
                    <button type="submit" class="btn btn-primary">${h.material_icon('save')} Salva</button>
                    {{/if}}
                </div>
            </div>
            <hr/>
            <div class="form-group {{errors.title ? 'has-error' : ''}}">
                <div class="col-sm-3">
                    <input id="extra-fields-form-title" type="text" class="form-control" placeholder="Titolo" value="{{create.title}}"/>
                    {{#if errors.title}}
                    <span class="help-block">{{errors.title}}</span>
                    {{/if}}
                </div>
            </div>
            <div class="form-group {{errors.category ? 'has-error' : ''}}">
                <div class="col-sm-3">
                    <select id="extra-fields-form-category" class="form-control" value="{{create.category}}">
                        <option value="" disabled selected>Seleziona una categoria</option>
                        {{#each categories}}
                        <option value="{{._id}}">{{.name}}</option>
                        {{/each}}
                    </select>

                    {{#if errors.category}}
                    <span class="help-block">{{errors.category}}</span>
                    {{/if}}
                </div>
            </div>
            <div class="form-group {{errors.question ? 'has-error' : ''}}">
                <div class="col-sm-3">
                    <input id="extra-fields-form-question" type="text" class="form-control" placeholder="Testo" value="{{create.question}}"/>
                    {{#if errors.question}}
                    <span class="help-block">{{errors.question}}</span>
                    {{/if}}
                </div>
            </div>
            <div class="form-group {{errors.tooltip ? 'has-error' : ''}}">
                <div class="col-sm-3">
                    <input id="extra-fields-form-tooltip" type="text" class="form-control" placeholder="Tooltip" value="{{create.tooltip}}"/>
                    {{#if errors.tooltip}}
                    <span class="help-block">{{errors.tooltip}}</span>
                    {{/if}}
                </div>
            </div>
            <div class="form-group {{errors.link ? 'has-error' : ''}}">
                <div class="col-sm-3">
                    <input id="extra-fields-form-link" type="text" class="form-control" placeholder="Link" value="{{create.link}}"/>
                    {{#if errors.link}}
                    <span class="help-block">{{errors.link}}</span>
                    {{/if}}
                </div>
            </div>
            <div class="form-group">
                <div class="col-md-12">
                    Tipo di risposta
                </div>
            </div>
            <div class="form-group {{errors.answer_type ? 'has-error' : ''}}">
                <div class="col-sm-10">
                    <label>
                        <input type="radio" name="answer_type" value="single" onclick="ractive_qa.switchResponseType('single');" />
                        <img src="${tg.url('/img/radio_single.png')}"  alt="Single"/>
                    </label>
                    <label>
                        <input type="radio" name="answer_type" value="multi" onclick="ractive_qa.switchResponseType('multi');" />
                        <img src="${tg.url('/img/radio_multi.png')}"  alt="Multi"/>
                    </label>
                    <label>
                        <input type="radio" name="answer_type" value="text" onclick="ractive_qa.switchResponseType('text');" />
                        <img src="${tg.url('/img/radio_text.png')}"  alt="Text"/>
                    </label>
                </div>
                {{#if errors.answer_type}}
                <span class="help-block">{{errors.answer_type}}</span>
                {{/if}}
            </div>
            {{#if answer_type == 'single' || answer_type == 'multi'}}
            <div class="form-group {{errors.answers ? 'has-error' : ''}}">

                {{#each available_reponse}}
                <div class="col-md-12">
                    <input type="{{input_type}}" name="example_response"> {{.}}
                </div>
                {{/each}}

                <div class="col-md-3">
                    <div class="form-inline">
                        <label for="response_text" onclick="ractive_qa.addResponse()">${h.material_icon('add_circle_outline')}</label>
                        <input id="response_text" type="text" class="form-control" placeholder="Answer"/>
                    </div>
                </div>
                {{#if errors.answers}}
                <span class="help-block">{{errors.answers}}</span>
                {{/if}}
            </div>
            {{/if}}

            {{#if answer_type == 'text'}}
            <div class="form-group">
                <div class="col-md-12">
                    Risposta di tipo testo
                </div>
            </div>
            {{/if}}
        </form>
    ]]>
    </script>
</head>

<body py:block="body" py:strip="True">
<div id="qa-ractive" style="padding-top: 20px">

</div>
<script>
    var QAEditor = Ractive.extend({
        template: '#QAForm_template',
        onconstruct: function(options) {
            var self = this;
            self.fieldset = options['fieldset'];
        },
        oninit: function() {
            var self = this;
            self.set('errors', {});
            self.set('saving', false);
            self.set('answer_type', null);
            self.set('input_type', null);
            self.set('available_reponse',[]);

            self.on('submit-form', function(event) {
                var all_var = self.get('create');
                // Now append answer_type and answers
                all_var['answer_type'] = self.get('answer_type');
                console.log(self.get('available_reponse'));
                all_var['answers'] = self.get('available_reponse');
                console.log(all_var);
                self.createQA(all_var);
                return false;
            });

            self.loadCategory();
        },
        loadCategory: function(callback) {
            var self = this;
            jQuery.get("${tg.url('/category/get_all')}",
                    function(data) {
                        self.set('categories', data['categories']);
                        if (callback)
                            callback();
                    });
        },
        switchResponseType: function(section) {
            var self = this;
            if(section == 'single')
                self.set('input_type', 'radio');
            if(section == 'multi')
                self.set('input_type', 'checkbox');

            jQuery("#insert_answer").empty();

            self.set('answer_type', section);
            self.set('available_reponse', []);
        },
        addResponse: function() {
            var self = this;
            jQuery("#insert_answer").empty();
            var resp = jQuery("#response_text").val();
            if(!resp || 0 === resp.length || /^\s*$/.test(resp)) {
                alert("Risposta non valida");
                return;
            }
            jQuery("#response_text").val("");
            self.push('available_reponse', resp);
        },
        createQA: function(field) {
            var self = this;
            self.set('saving', true);
            console.log("JSON.stringify");
            console.log(JSON.stringify(field));

            var api_params = JSON.stringify(field);

            $.ajax({
                type: "post",
                url: "${tg.url('/qa/post')}",
                data: api_params,
                dataType: "json",
                processData: false,
                contentType: 'application/json'
            }).done(function(data) {
                self.set('create', {});
                self.set('saving', false);
                self.set('editing', false);
                window.location.replace("${tg.url('/qa/')}");

            }).fail(function(jqXHR) {
                var data = jQuery.parseJSON(jqXHR.responseText);
                console.log("fail");
                console.log(data);
                self.set('errors', data.errors);
                self.set('saving', false);
            });
        }
    });
</script>
<script>
    var ractive_qa = new QAEditor({fieldset: 'qa', el: '#qa-ractive'});
</script>
</body>
</html>
